#!/usr/bin/env python3
"""
Teste Completo do Sistema - Verifica TODAS as funcionalidades implementadas
"""

import asyncio
import sys
from pathlib import Path

# Adiciona o diret√≥rio do projeto ao path
sys.path.insert(0, str(Path(__file__).parent))

from gemini_code.core.master_system import initialize_gemini_code


async def test_complete_initialization():
    """Testa inicializa√ß√£o completa do sistema."""
    print("üß™ TESTE COMPLETO - INICIALIZA√á√ÉO DO SISTEMA")
    print("=" * 80)
    
    try:
        # Inicializa sistema completo
        system = await initialize_gemini_code()
        
        # Verifica se todos os componentes foram inicializados
        components_check = {
            'Gemini Client': system.gemini_client is not None,
            'Project Manager': system.project_manager is not None,
            'Memory System': system.memory_system is not None,
            'Tool Registry': system.tool_registry is not None,
            'Permission Manager': system.permission_manager is not None,
            'Session Manager': system.session_manager is not None,
            'Command Parser': system.command_parser is not None,
            'Context Compactor': system.context_compactor is not None,
            'MCP Client': system.mcp_client is not None,
            'Health Monitor': system.health_monitor is not None,
            'Error Detector': system.error_detector is not None,
            'REPL Interface': system.repl is not None
        }
        
        print("üîç VERIFICA√á√ÉO DE COMPONENTES:")
        all_ok = True
        for component, status in components_check.items():
            icon = "‚úÖ" if status else "‚ùå"
            print(f"  {icon} {component}")
            if not status:
                all_ok = False
        
        print(f"\nüìä Status: {'TODOS OS COMPONENTES OK' if all_ok else 'ALGUNS COMPONENTES FALHARAM'}")
        
        return system, all_ok
        
    except Exception as e:
        print(f"‚ùå ERRO NA INICIALIZA√á√ÉO: {e}")
        import traceback
        traceback.print_exc()
        return None, False


async def test_system_capabilities(system):
    """Testa capacidades espec√≠ficas do sistema."""
    print("\nüß™ TESTE DE CAPACIDADES ESPEC√çFICAS")
    print("=" * 80)
    
    tests = []
    
    # 1. Teste de Tools
    try:
        tools = system.tool_registry.list_tools()
        tests.append(("Tool Registry", len(tools) >= 10, f"{len(tools)} ferramentas"))
    except Exception as e:
        tests.append(("Tool Registry", False, f"Erro: {e}"))
    
    # 2. Teste de Command Parsing
    try:
        result = await system.command_parser.parse_slash_command("/help")
        tests.append(("Command Parser", result['type'] == 'help', "Parse de /help"))
    except Exception as e:
        tests.append(("Command Parser", False, f"Erro: {e}"))
    
    # 3. Teste de Health Check
    try:
        health = await system.comprehensive_health_check()
        tests.append(("Health Check", health['overall_status'] in ['healthy', 'degraded'], f"Status: {health['overall_status']}"))
    except Exception as e:
        tests.append(("Health Check", False, f"Erro: {e}"))
    
    # 4. Teste de MCP
    try:
        mcp_health = await system.mcp_client.health_check()
        tests.append(("MCP Client", True, "Cliente MCP funcional"))
    except Exception as e:
        tests.append(("MCP Client", False, f"Erro: {e}"))
    
    # 5. Teste de Memory System
    try:
        await system.memory_system.add_conversation("teste", "resposta teste", "test", True)
        tests.append(("Memory System", True, "Salvou conversa de teste"))
    except Exception as e:
        tests.append(("Memory System", False, f"Erro: {e}"))
    
    # 6. Teste de Permissions
    try:
        security_status = system.permission_manager.get_security_status()
        tests.append(("Permission Manager", isinstance(security_status, dict), "Status de seguran√ßa obtido"))
    except Exception as e:
        tests.append(("Permission Manager", False, f"Erro: {e}"))
    
    # Mostra resultados
    successful_tests = 0
    for test_name, success, details in tests:
        icon = "‚úÖ" if success else "‚ùå"
        print(f"  {icon} {test_name:20} - {details}")
        if success:
            successful_tests += 1
    
    print(f"\nüìä RESULTADO: {successful_tests}/{len(tests)} testes passaram")
    return successful_tests, len(tests)


async def test_claude_code_parity(system):
    """Verifica paridade espec√≠fica com Claude Code."""
    print("\nüéØ TESTE DE PARIDADE COM CLAUDE CODE")
    print("=" * 80)
    
    # Funcionalidades essenciais do Claude Code
    claude_features = [
        ("Terminal REPL nativo", system.repl is not None),
        ("Comandos slash (/help, /cost, etc.)", system.command_parser is not None),
        ("Sistema de tools estruturado", len(system.tool_registry.tools) >= 10),
        ("BashTool para execu√ß√£o", 'bash' in system.tool_registry.tools),
        ("File tools (read/write/edit)", all(t in system.tool_registry.tools for t in ['read', 'write', 'edit'])),
        ("Search tools (glob/grep/find)", all(t in system.tool_registry.tools for t in ['glob', 'grep', 'find'])),
        ("Sistema de permiss√µes", system.permission_manager is not None),
        ("Gest√£o de sess√µes", system.session_manager is not None),
        ("Compacta√ß√£o de contexto", system.context_compactor is not None),
        ("MCP support", system.mcp_client is not None),
        ("Health monitoring", system.health_monitor is not None),
        ("Comando natural parsing", hasattr(system.tool_registry, 'execute_command_natural'))
    ]
    
    # Funcionalidades superiores (que v√£o al√©m do Claude Code)
    superior_features = [
        ("Sistema de mem√≥ria SQLite", system.memory_system is not None),
        ("Business Intelligence", hasattr(system, 'analytics_engine')),
        ("Self-healing autom√°tico", system.error_detector is not None),
        ("Health monitoring cont√≠nuo", system.health_monitor is not None),
        ("Sistema master integrado", True),  # Esta pr√≥pria arquitetura
        ("Suporte enterprise (Bedrock)", hasattr(system, 'bedrock_manager'))
    ]
    
    # Conta funcionalidades implementadas
    claude_implemented = sum(1 for _, implemented in claude_features if implemented)
    superior_implemented = sum(1 for _, implemented in superior_features if implemented)
    
    print("üìã FUNCIONALIDADES DO CLAUDE CODE:")
    for feature, implemented in claude_features:
        icon = "‚úÖ" if implemented else "‚ùå"
        print(f"  {icon} {feature}")
    
    print("\nüöÄ FUNCIONALIDADES SUPERIORES (AL√âM DO CLAUDE CODE):")
    for feature, implemented in superior_features:
        icon = "‚úÖ" if implemented else "‚ùå"
        print(f"  {icon} {feature}")
    
    # Calcula porcentagem
    claude_parity = (claude_implemented / len(claude_features)) * 100
    superiority = (superior_implemented / len(superior_features)) * 100
    
    print(f"\nüìä RESULTADOS:")
    print(f"  üéØ Paridade Claude Code: {claude_parity:.1f}% ({claude_implemented}/{len(claude_features)})")
    print(f"  üöÄ Funcionalidades Superiores: {superiority:.1f}% ({superior_implemented}/{len(superior_features)})")
    
    # Status final
    if claude_parity >= 90:
        if superiority >= 70:
            status = "üèÜ SUPERIOR AO CLAUDE CODE"
        else:
            status = "‚úÖ PARIDADE COMPLETA"
    elif claude_parity >= 80:
        status = "üü° QUASE COMPLETO"
    else:
        status = "üî¥ PRECISA MELHORIAS"
    
    print(f"  üèÖ Status Final: {status}")
    
    return claude_parity, superiority


async def test_performance_and_stats(system):
    """Testa performance e estat√≠sticas."""
    print("\n‚ö° TESTE DE PERFORMANCE E ESTAT√çSTICAS")
    print("=" * 80)
    
    try:
        # Obt√©m estat√≠sticas do sistema
        stats = system.get_system_stats()
        
        print("üìä ESTAT√çSTICAS DO SISTEMA:")
        key_stats = [
            ("Vers√£o", stats.get('version', 'N/A')),
            ("Tempo de atividade", stats.get('uptime_formatted', 'N/A')),
            ("Comandos executados", stats.get('total_commands', 0)),
            ("Opera√ß√µes bem-sucedidas", stats.get('successful_operations', 0)),
            ("Paridade calculada", f"{stats.get('parity_percentage', 0)}%"),
            ("Sistema inicializado", "Sim" if stats.get('is_initialized') else "N√£o")
        ]
        
        for key, value in key_stats:
            print(f"  ‚Ä¢ {key}: {value}")
        
        # Tool statistics
        if 'tool_stats' in stats:
            tool_stats = stats['tool_stats']
            registry_stats = tool_stats.get('registry_stats', {})
            print(f"  ‚Ä¢ Ferramentas registradas: {registry_stats.get('total_tools', 0)}")
            print(f"  ‚Ä¢ Execu√ß√µes de ferramentas: {registry_stats.get('total_executions', 0)}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erro obtendo estat√≠sticas: {e}")
        return False


async def main():
    """Fun√ß√£o principal de teste."""
    print("üß™ TESTE COMPLETO DO GEMINI CODE SYSTEM")
    print("Verificando TODAS as funcionalidades implementadas")
    print("=" * 80)
    
    # 1. Teste de inicializa√ß√£o
    system, init_ok = await test_complete_initialization()
    
    if not init_ok or not system:
        print("\n‚ùå FALHA NA INICIALIZA√á√ÉO - INTERROMPENDO TESTES")
        return 1
    
    # 2. Teste de capacidades
    successful_tests, total_tests = await test_system_capabilities(system)
    
    # 3. Teste de paridade com Claude Code
    claude_parity, superiority = await test_claude_code_parity(system)
    
    # 4. Teste de performance
    perf_ok = await test_performance_and_stats(system)
    
    # Resultado final
    print("\n" + "=" * 80)
    print("üèÜ RESULTADO FINAL DO TESTE COMPLETO")
    print("=" * 80)
    
    overall_score = (
        (50 if init_ok else 0) +
        (30 * successful_tests / total_tests) +
        (20 * claude_parity / 100)
    )
    
    print(f"üìä PONTUA√á√ÉO GERAL: {overall_score:.1f}/100")
    print(f"üéØ Paridade Claude Code: {claude_parity:.1f}%")
    print(f"üöÄ Funcionalidades Superiores: {superiority:.1f}%")
    print(f"‚úÖ Testes Passaram: {successful_tests}/{total_tests}")
    
    if overall_score >= 90:
        final_status = "üèÜ SISTEMA EXCELENTE - SUPERIOR AO CLAUDE CODE"
    elif overall_score >= 80:
        final_status = "‚úÖ SISTEMA BOM - PARIDADE ALTA"
    elif overall_score >= 70:
        final_status = "üü° SISTEMA FUNCIONAL - PRECISA AJUSTES"
    else:
        final_status = "üî¥ SISTEMA PRECISA MELHORIAS SIGNIFICATIVAS"
    
    print(f"\nüéñÔ∏è STATUS FINAL: {final_status}")
    
    # Shutdown gracioso
    try:
        await system.shutdown()
    except:
        pass
    
    print("\n‚úÖ TESTE COMPLETO FINALIZADO")
    return 0 if overall_score >= 80 else 1


if __name__ == "__main__":
    result = asyncio.run(main())
    sys.exit(result)